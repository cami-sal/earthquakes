<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>World Earthquakes of Magnitude 7.0+ in 100 years, 1925-2025.</title>
<!-- Leaflet CSS and JavaScript -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- D3 for data processing and UI controls -->
<script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>

<style>
  :root{
    --bg:#0b1220;
    --panel:#0f1724;
    --accent:#ff6b3d;
    --ocean:#def0fc; /* light blue ocean */
    --pink:#ff2aa1; /* slider & circle color */
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica;background:linear-gradient(180deg,#06224a 0%, #2a0b4a 100%);color:#fff}
  .wrap{display:flex;flex-direction:column;height:100vh}
  header{padding:8px 12px;background:linear-gradient(90deg,#071226,#0b1220);display:flex;align-items:center;gap:12px;border-radius:8px;margin:8px}
  header h1{margin:0 auto;font-size:18px;text-align:center}
  #vis{flex:1;display:grid;grid-template-columns:320px 1fr;gap:8px;padding:8px;position:relative;height:calc(100vh - 60px)}
  .sidebar{position:static;width:auto;height:calc(100vh - 60px);max-height:calc(100vh - 60px);
    background: linear-gradient(180deg, rgba(6,34,74,0.45) 0%, rgba(42,11,74,0.45) 100%);
    border:1px solid rgba(255,255,255,0.18);
    border-radius:12px;color:#e7f0ff;z-index:10;display:flex;flex-direction:column;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .sidebar header{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.2);font-size:14px}
  /* Consolidated scrollbar utility class */
  .custom-scrollbar { overflow-y: scroll; overflow-x: hidden; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.4) rgba(255,255,255,0.1); }
  .custom-scrollbar::-webkit-scrollbar { width: 8px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.4); border-radius: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.6); }
  
  .sidebar .content{flex:1 1 0;padding:10px 12px;min-height:0;height:400px}
  .sidebar .content > *{flex-shrink:0}
  .sidebar .content .sidebar-section{flex-shrink:0}
  
  /* Utility classes for common inline styles */
  .flex-between{display:flex;align-items:center;justify-content:space-between}
  .year-input{width:70px;text-align:center}
  .hidden{display:none}
  .histogram-container{position:relative;height:30px;margin:0 10px 5px 10px}
  .map-container{position:relative;width:100%;height:100%}
  .info-section{margin-top:20px;padding:10px;background:rgba(255,255,255,0.05);border-radius:4px}
  .info-section-large{margin-top:15px;padding:15px;background:rgba(255,255,255,0.05);border-radius:6px}
  .text-left{text-align:left;margin:10px 0}
  .list-left{margin:10px 0;padding-left:20px}
  .welcome-header{margin-bottom:20px;padding:12px 16px;background:rgba(255,255,255,0.05);border-radius:6px;text-align:center}
  .welcome-header h3{margin:0 0 6px 0;color:#fff;font-size:16px;font-weight:600}
  .welcome-header p{margin:0;color:#e7f0ff;font-size:13px;opacity:0.9;line-height:1.3}
  .help-button{width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#e7f0ff;font-size:14px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 120ms ease;margin:0}
  .help-button:hover{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.4);transform:scale(1.1)}
  .visualization-legend{margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:6px}
  .visualization-legend h3{margin:0 0 15px 0;color:#fff;font-size:16px;font-weight:600;text-align:center}
  .visualization-legend h4{margin:0 0 8px 0;color:#fff;font-size:14px;font-weight:600;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:4px}
  .visualization-legend .legend-section{margin-bottom:15px}
  .visualization-legend .legend-section:last-child{margin-bottom:0}
  .visualization-legend .legend-item{margin-bottom:6px;display:flex;align-items:flex-start;gap:8px}
  .visualization-legend .legend-item:last-child{margin-bottom:0}
  .visualization-legend .legend-circle{flex-shrink:0;border-radius:50%;border:1px solid rgba(255,255,255,0.3);margin-top:2px}
  .visualization-legend .legend-text{color:#e7f0ff;font-size:12px;line-height:1.4}
  .visualization-legend .legend-text strong{color:#fff;font-weight:600}
  .welcome-message{padding:16px;text-align:center;color:#e7f0ff}
  .welcome-message h3{margin:0 0 8px 0;color:#fff;font-size:16px}
  .welcome-message p{margin:0;font-size:13px;opacity:0.8}
  .sidebar .item{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06);font-size:13px}
  .sidebar .item:last-child{border-bottom:none}
  .sidebar-section{padding:12px;border-top:1px solid rgba(255,255,255,0.1);margin-top:8px}
  .sidebar-section h3{margin:0 0 12px 0;font-size:14px;color:#e7f0ff;font-weight:600}
  .filter-group{margin-bottom:12px}
  .filter-group label{display:block;font-size:12px;color:#e7f0ff;margin-bottom:4px;font-weight:500}
  .filter-group select, .filter-group input{width:100%;margin-bottom:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);padding:6px 8px;border-radius:4px;color:#e7f0ff;font-size:12px}
  .magnitude-range{margin-bottom:6px}
  .range-labels{display:flex;justify-content:space-between;margin-bottom:8px;font-size:11px;color:#e7f0ff}
  .range-inputs{display:flex;gap:8px;align-items:center}
  .range-inputs input[type="range"]{flex:1;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;outline:none;cursor:pointer}
  .range-inputs input[type="range"]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;background:#e7f0ff;border-radius:50%;cursor:pointer;border:2px solid rgba(255,255,255,0.3)}
  .range-inputs input[type="range"]::-moz-range-thumb{width:16px;height:16px;background:#e7f0ff;border-radius:50%;cursor:pointer;border:2px solid rgba(255,255,255,0.3);border:none}
  .filter-group select:focus, .filter-group input:focus{outline:none;border-color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.15)}
  .filter-group button{width:100%;padding:6px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#e7f0ff;cursor:pointer;font-size:12px;transition:all 120ms ease}
  .filter-group button:hover{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.3)}
  #sliderWrap{margin-top:4px}
  #sliderWrap input[type="range"]{width:100%;margin:0}
  .active-filters{margin-top:12px;padding:8px;background:rgba(255,255,255,0.05);border-radius:4px;font-size:11px;color:#e7f0ff}
  .active-filters div{margin-bottom:4px}
  .active-filters div:last-child{margin-bottom:0}
  .view-controls{margin-top:12px;padding:8px;border-top:1px solid rgba(255,255,255,0.1)}
  .view-controls h3{margin:0 0 8px 0;font-size:12px;color:#e7f0ff;font-weight:600}
  .view-buttons{display:flex;gap:6px}
  .view-btn{flex:1;padding:6px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#e7f0ff;cursor:pointer;font-size:11px;transition:all 120ms ease}
  .view-btn:hover{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.3)}
  .view-btn.active{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.4);color:#fff}
  .summary-toggle{background:rgba(15,23,36,0.9);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 12px;cursor:pointer;display:flex;justify-content:flex-start;align-items:center;font-size:13px;font-weight:600;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:all 200ms ease;pointer-events:auto;min-width:80px;gap:8px}
  .summary-toggle:hover{background:rgba(15,23,36,0.95);box-shadow:0 6px 16px rgba(0,0,0,0.4)}
  .transparency-toggle{background:rgba(15,23,36,0.9);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 12px;cursor:pointer;display:flex;justify-content:flex-start;align-items:center;font-size:13px;font-weight:600;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:all 200ms ease;pointer-events:auto;min-width:80px;gap:8px}
  .transparency-toggle:hover{background:rgba(15,23,36,0.95);box-shadow:0 6px 16px rgba(0,0,0,0.4)}
  .summary-section{padding:12px;background:rgba(15,23,36,0.9);border:1px solid rgba(255,255,255,0.15);border-radius:8px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:200px;margin-top:4px}
  .transparency-section{padding:12px;background:rgba(15,23,36,0.9);border:1px solid rgba(255,255,255,0.15);border-radius:8px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:200px;margin-top:4px}
  .summary-stats{display:flex;flex-direction:column;gap:6px}
  .stat-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
  .stat-item:last-child{border-bottom:none}
  .stat-label{font-size:11px;color:#e7f0ff;opacity:0.8}
  .stat-value{font-size:12px;color:#fff;font-weight:600}
  .legend-overlay{position:absolute;top:12px;right:12px;z-index:1000;pointer-events:auto}
  .legend-toggle{background:rgba(15,23,36,0.9);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:8px 12px;cursor:pointer;display:flex;justify-content:flex-start;align-items:center;font-size:13px;font-weight:600;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:all 200ms ease;pointer-events:auto;min-width:80px;gap:8px}
  .legend-toggle:hover{background:rgba(15,23,36,0.95);box-shadow:0 6px 16px rgba(0,0,0,0.4)}
  .toggle-icon{transition:transform 200ms ease;font-size:10px}
  .legend-toggle.expanded .toggle-icon{transform:rotate(180deg)}
  .legend-section{padding:12px;background:rgba(15,23,36,0.9);border:1px solid rgba(255,255,255,0.15);border-radius:8px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:180px;margin-top:4px}
  .legend-section h3{margin:0 0 12px 0;font-size:14px;color:#fff;font-weight:600}
  .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:12px;pointer-events:auto;cursor:pointer;padding:4px;border-radius:4px;transition:all 200ms ease}
  .legend-item:hover{background:rgba(255,255,255,0.1);transform:translateX(2px)}
  .legend-item:last-child{margin-bottom:0}
  .legend-checkbox{width:16px;height:16px;margin-right:4px;cursor:pointer;accent-color:rgba(255,255,255,0.8);flex-shrink:0}
  .legend-circle{flex-shrink:0;border-radius:50%;border:1px solid rgba(255,255,255,0.2);transition:all 200ms ease}
  .legend-item:hover .legend-circle{transform:scale(1.1);box-shadow:0 0 8px rgba(255,255,255,0.3)}
  .legend-text{color:#e7f0ff;line-height:1.3;transition:all 200ms ease;flex:1}
  .legend-item:hover .legend-text{color:#fff}
  .legend-magnitude{font-weight:600;color:#fff;transition:all 200ms ease}
  .legend-item:hover .legend-magnitude{color:#ffd54a}
  .legend-item.selected{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3)}
  .legend-item.unselected{opacity:0.4}
  #map-container{width:100%;height:100%;position:relative}
  #map{width:100%;height:100%;background:#E0E0E0;min-height:500px}
  #land .country{transition:fill 120ms ease}
  #land .country:hover{fill:#e7e3da}
  .earthquake-highlighted{opacity:1 !important;transition:all 300ms ease}
  .earthquake-dimmed{opacity:0.3 !important;transition:all 300ms ease}
  .earthquake-visible{opacity:1 !important;transition:all 300ms ease}
  .earthquake-hidden{opacity:0 !important;transition:all 300ms ease}
  /* Controls bottom */
  .controls{
    display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.06));
    flex-wrap:wrap;
  }
  .label{min-width:130px;font-size:14px}
  input[type=range]{flex:1;width:100%;accent-color:var(--pink);margin:0;-webkit-appearance:none;appearance:none;background:transparent}
  input[type=range]::-webkit-slider-runnable-track{height:4px;background:rgba(255,255,255,0.25);border-radius:2px}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:var(--pink);border:2px solid #fff;margin-top:-5px}
  input[type=range]::-moz-range-track{height:4px;background:rgba(255,255,255,0.25);border-radius:2px}
  input[type=range]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--pink);border:2px solid #fff}
  /* Slider wrap wider and decade tick labels */
  #sliderWrap{position:relative;flex:1 1 100%;margin:0 10px;min-width:200px;max-width:100%}
  .tick-labels{position:relative;height:20px;margin-bottom:8px;font-size:12px;color:#cfd8e3;opacity:0.9;padding-right:16px}
  .tick-labels .tick{position:absolute;top:5px;transform:translateX(-50%);text-align:center;white-space:nowrap;z-index:1}
  .tick-labels .tick::before{content:"";position:absolute;top:-6px;left:50%;width:1px;height:6px;background:#9db7d1;opacity:0.7}
  .tick-labels .tick.first{transform:none}
  .tick-labels .tick.first::before{left:0}
  .tick-labels .tick.last{transform:translateX(-100%)}
  .tick-labels .tick.last::before{left:100%}
  button{background:var(--panel);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
  button:active{transform:translateY(1px)}
  select, input[type=number]{background:var(--panel);border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:#fff}
  footer{font-size:11px;color:#cfd8e3;padding:4px 8px;background:linear-gradient(90deg,#07122611,#0b122011)}
  
  @media (max-width: 1024px) {
    #vis {
      grid-template-columns: 1fr; /* A single flexible column */
      height: auto;
    }
    .sidebar {
      height: auto; /* Allow sidebar to shrink */
      max-height: 40vh; /* Prevent it from taking too much space */
    }
    #map-container {
      height: 50vh; /* Ensure map has enough space */
    }
    .summary-section, .legend-section, .transparency-section {
      display: none;
    }
    .summary-toggle.expanded + .summary-section,
    .legend-toggle.expanded + .legend-section,
    .transparency-toggle.expanded + .transparency-section {
      display: block; /* Ensure toggling still works */
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Worldwide Earthquakes of Magnitude 7.0+</h1>
    <div style="opacity:0.85;font-size:13px">Data: local file <strong>earthquakes_cleaned_full.json</strong> (USGS). Move slider or Play.</div>
  </header>

  <div id="vis">
    <aside class="sidebar custom-scrollbar">
      <div id="sidebarList" class="content custom-scrollbar">
        <div class="welcome-header">
          <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 4px;">
            <h3>This is the Earthquake Map</h3>
            <button id="helpBtn" class="help-button" title="Show help information" onclick="document.getElementById('helpModal').style.display='block'">?</button>
          </div>
          <p>Click on the button for detailed information</p>
        </div>
        
        <div class="view-controls">
          <h3>View Mode</h3>
          <div class="view-buttons">
            <button id="defaultViewBtn" class="view-btn active">Cumulative View</button>
            <button id="animationViewBtn" class="view-btn">Single Year View</button>
          </div>
        </div>
        
        <!-- Histogram section - only visible in single year view -->
        <div class="sidebar-section" id="histogramSection" style="display: none;">
          <h3>Earthquake Distribution by Year</h3>
          <div id="yearHistogram" class="histogram-container"></div>
        </div>
        
        <div class="sidebar-section" id="yearControlsSection" style="display: none;">
          <h3>Year Controls</h3>
          
          <div class="filter-group">
            <div class="label flex-between">
              <span>Year: <strong id="yearLabel">Loading...</strong></span>
              <input id="specificYearInput" type="number" class="year-input">
            </div>
    <div id="sliderWrap">
      <div id="yearTickLabels" class="tick-labels"></div>
              <div id="yearGuide" class="hidden"></div>
      <input id="yearSlider" type="range" step="1" list="yearDatalist">
      <datalist id="yearDatalist"></datalist>
    </div>
          </div>
          
          <div class="filter-group">
            <label for="speedControl">Animation Speed:</label>
            <select id="speedControl">
              <option value="1000">Slow (0.5x)</option>
              <option value="500" selected>Normal (1x)</option>
              <option value="250">Fast (2x)</option>
            </select>
          </div>
          
          <div class="filter-group">
    <button id="playBtn" aria-pressed="false">Play ▶</button>
    </div>
  </div>
        
        <div class="sidebar-section">
          <h3>Filters</h3>
          <div class="filter-group">
            <label>Country Filter:</label>
            <select id="countrySelect"><option value="">All Countries</option></select>
          </div>
          
          <div class="filter-group">
            <label>Magnitude Range:</label>
            <div class="magnitude-range">
              <div class="range-labels">
                <span id="minMagLabel">7.0</span>
                <span id="maxMagLabel">9.5</span>
              </div>
              <div class="range-inputs">
                <input type="range" id="minMagSlider" min="7.0" max="9.5" step="0.1" value="7.0">
                <input type="range" id="maxMagSlider" min="7.0" max="9.5" step="0.1" value="9.5">
              </div>
            </div>
          </div>
          
          <div class="filter-group">
            <button id="clearFiltersBtn">Clear All Filters</button>
          </div>
          
          <div class="active-filters">
            <div>Active Country: <strong id="activeCountryText">None</strong></div>
            <div>Active Year: <strong id="activeYearText">None</strong></div>
            <div>Magnitude Range: <strong id="activeMagText">7.0 - 9.5</strong></div>
          </div>
        </div>
      </div>
      
    </aside>
    <div id="map-container" class="map-container">
      <div id="map"></div>
      
      <div class="legend-overlay">
        <div class="legend-toggle" id="legendToggle" title="Toggle Magnitude Legend" onclick="toggleLegend()">
          <span>Magnitude Legend</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="legend-section" id="legendSection" style="display: none;">
          <h3>Magnitude Legend</h3>
          <div id="magnitudeLegend"></div>
      </div>
      
        <div class="summary-toggle" id="summaryToggle" title="Toggle Summary Panel" onclick="toggleSummary()" style="margin-top: 8px;">
          <span>Summary</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="summary-section" id="summarySection" style="display: none;">
          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-label">Total Earthquakes:</div>
              <div class="stat-value" id="totalEarthquakes">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Largest Magnitude:</div>
              <div class="stat-value" id="largestMagnitude">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Most Active Country:</div>
              <div class="stat-value" id="mostActiveCountry">-</div>
            </div>
          </div>
        </div>
        
        <div class="transparency-toggle" id="transparencyToggle" title="Toggle Transparency Legend" onclick="toggleTransparency()" style="margin-top: 8px;">
          <span>Transparency</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="transparency-section" id="transparencySection" style="display: none;">
          <div class="transparency-legend">
            <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #e7f0ff; font-weight: 600;">Transparency by Year</h4>
            <div class="transparency-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div class="transparency-circle" style="width: 12px; height: 12px; border-radius: 50%; background: #FFD700; opacity: 0.2;"></div>
              <div class="transparency-label" style="font-size: 11px; color: #e7f0ff;">1925-1950: Very Old (20% opacity)</div>
            </div>
            <div class="transparency-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div class="transparency-circle" style="width: 12px; height: 12px; border-radius: 50%; background: #FFD700; opacity: 0.4;"></div>
              <div class="transparency-label" style="font-size: 11px; color: #e7f0ff;">1950-1975: Old (40% opacity)</div>
            </div>
            <div class="transparency-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div class="transparency-circle" style="width: 12px; height: 12px; border-radius: 50%; background: #FFD700; opacity: 0.6;"></div>
              <div class="transparency-label" style="font-size: 11px; color: #e7f0ff;">1975-2000: Recent (60% opacity)</div>
            </div>
            <div class="transparency-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div class="transparency-circle" style="width: 12px; height: 12px; border-radius: 50%; background: #FFD700; opacity: 0.8;"></div>
              <div class="transparency-label" style="font-size: 11px; color: #e7f0ff;">2000-2015: Very Recent (80% opacity)</div>
            </div>
            <div class="transparency-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div class="transparency-circle" style="width: 12px; height: 12px; border-radius: 50%; background: #FFD700; opacity: 1.0;"></div>
              <div class="transparency-label" style="font-size: 11px; color: #e7f0ff;">2015-2025: Current (100% opacity)</div>
            </div>
            <div class="transparency-note" style="margin-top: 8px; font-size: 10px; color: #e7f0ff; opacity: 0.7; font-style: italic;">
              Older earthquakes appear more translucent, newer ones are fully opaque
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <footer>
    Data source: U.S. Geological Survey (USGS)
  </footer>
</div>

<script>
(async () => {
  // Initialize Leaflet map
  const map = L.map('map').setView([20, 0], 2);

  // Add Carto Light tile layer
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
  }).addTo(map);

  // Create layers for earthquakes and countries
  let earthquakeLayer = L.layerGroup().addTo(map);
  let countryLayer;
  let allEarthquakesData = [];

  // Tooltip

  // Country layer removed - using only the tile layer for clean appearance

  // Load earthquake data
  const quakeData = await fetch("earthquakes_cleaned_full.json").then(r => r.json());
  
  // Filter out the 2004 Sumatra earthquake
  const filteredQuakeData = quakeData.filter(quake => 
    !(quake.place && quake.place.includes('2004 Sumatra - Andaman Islands Earthquake'))
  );

  // Helper to find country name by point - simplified since no country layer
  function getCountryNameFromPoint(lon, lat) {
    // Since we removed the country layer, just return "Unknown" for now
    // The earthquake data already has country information, so this is mainly a fallback
    return "Unknown";
  }

  console.log('Processing earthquake data...');
  console.log('Raw data length:', quakeData.length);
  console.log('Filtered data length:', filteredQuakeData.length);
  console.log('Sample data point:', filteredQuakeData[0]);
  
  const quakes = filteredQuakeData.map((f, index) => {
    let lon = f.longitude;
    let lat = f.latitude;
    const depth = f.depth;
    const year = f.year;
    
    // Fix data quality issues
    if (lat < -90 || lat > 90) {
      // If latitude is clearly wrong, try to fix it
      if (Math.abs(lat) > 1000) {
        lat = lat / 1000; // Divide by 1000 to get reasonable latitude
      } else if (lat < -90) {
        // If latitude is negative and too small, it might be missing decimal point
        lat = lat / 100; // Try dividing by 100
      }
    }
    if (lon < -180 || lon > 180) {
      // If longitude is clearly wrong, try to fix it
      if (Math.abs(lon) > 1000) {
        lon = lon / 1000; // Divide by 1000 to get reasonable longitude
      }
    }
    
    // Special case for Gorontalo, Indonesia earthquakes (known data quality issues)
    if (f.place && f.place.includes('Gorontalo, Indonesia')) {
      // Gorontalo is at approximately 0.5°N, 123.1°E
      if (lat < -90 || lat > 90 || Math.abs(lat) > 10) {
        lat = 0.5; // Set to approximate Gorontalo latitude
      }
      if (lon < 120 || lon > 130) {
        lon = 123.1; // Set to approximate Gorontalo longitude
      }
    }
    
    // Final coordinate validation and last-chance fixes
    if (isNaN(lat) || isNaN(lon)) {
      console.warn('Skipping earthquake with NaN coordinates:', f);
      skippedCount++;
      return null;
    }
    
    // Last-chance coordinate fixes for any remaining issues
    if (lat < -90 || lat > 90) {
      console.warn('Attempting final latitude fix for:', f.place, 'lat:', lat);
      if (Math.abs(lat) > 1000) {
        lat = lat / 1000;
      } else if (Math.abs(lat) > 100) {
        lat = lat / 100;
      } else if (lat < -90) {
        lat = lat / 10;
      }
    }
    
    if (lon < -180 || lon > 180) {
      console.warn('Attempting final longitude fix for:', f.place, 'lon:', lon);
      if (Math.abs(lon) > 1000) {
        lon = lon / 1000;
      } else if (Math.abs(lon) > 180) {
        lon = lon / 100;
      }
    }
    
    // Final validation - skip if still invalid
    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
      console.warn('Skipping earthquake with unfixable coordinates:', f, 'lat:', lat, 'lon:', lon);
      skippedCount++;
      return null;
    }
    
    // Log any coordinates that seem suspicious for debugging
    if (Math.abs(lat) > 10 || Math.abs(lon) > 180) {
      console.log('Suspicious coordinates detected:', {
        place: f.place,
        originalLat: f.latitude,
        originalLon: f.longitude,
        correctedLat: lat,
        correctedLon: lon
      });
    }
    
    // Create a date from the year (using January 1st as placeholder)
    const date = new Date(year, 0, 1);
    
    // Extract country from place string
    const place = f.place || '';
    let country = 'Unknown';
    
    // Try to extract country from place string
    if (place.includes(',')) {
      const parts = place.split(',');
      country = parts[parts.length - 1].trim();
    } else if (place.includes('region') || place.includes('Island')) {
      country = place;
    } else if (place.includes('Russia')) {
      country = 'Russia';
    } else if (place.includes('Japan')) {
      country = 'Japan';
    } else if (place.includes('Chile')) {
      country = 'Chile';
    } else if (place.includes('Indonesia')) {
      country = 'Indonesia';
    } else if (place.includes('Philippines')) {
      country = 'Philippines';
    } else if (place.includes('Tonga')) {
      country = 'Tonga';
    } else if (place.includes('Vanuatu')) {
      country = 'Vanuatu';
    } else if (place.includes('Peru')) {
      country = 'Peru';
    } else if (place.includes('Taiwan')) {
      country = 'Taiwan';
    } else if (place.includes('China')) {
      country = 'China';
    } else if (place.includes('Mexico')) {
      country = 'Mexico';
    } else if (place.includes('Alaska')) {
      country = 'United States';
    } else if (place.includes('California')) {
      country = 'United States';
    } else if (place.includes('Turkey')) {
      country = 'Turkey';
    } else if (place.includes('New Zealand')) {
      country = 'New Zealand';
    } else if (place.includes('Fiji')) {
      country = 'Fiji';
    } else if (place.includes('Solomon Islands')) {
      country = 'Solomon Islands';
    } else if (place.includes('Papua New Guinea')) {
      country = 'Papua New Guinea';
    } else if (place.includes('Myanmar') || place.includes('Burma')) {
      country = 'Myanmar';
    } else if (place.includes('Cayman Islands')) {
      country = 'Cayman Islands';
    } else if (place.includes('Tibet')) {
      country = 'China';
    } else if (place.includes('Macquarie Island')) {
      country = 'Australia';
    } else if (place.includes('Bihar') || place.includes('Nepal')) {
      country = 'Nepal';
    } else if (place.includes('Sulawesi')) {
      country = 'Indonesia';
    } else if (place.includes('Hyuganada') || place.includes('Toankai') || place.includes('Tokachi') || place.includes('Hokkaido')) {
      country = 'Japan';
    } else if (place.includes('Makran')) {
      country = 'Pakistan';
    } else if (place.includes('Sumatra') || place.includes('Andaman')) {
      country = 'Indonesia';
    } else if (place.includes('Sea') || place.includes('Ocean') || place.includes('Basin') || 
               place.includes('Passage') || place.includes('Trench') || place.includes('Ridge') ||
               place.includes('Plateau') || place.includes('Rise') || place.includes('Abyssal') ||
               place.includes('Deep') || place.includes('Gulf') || place.includes('Bay') ||
               place.includes('Strait') || place.includes('Channel') || place.includes('Shelf')) {
      // Mark oceanic/sea locations as Unknown to exclude them from country filter
      country = 'Unknown';
    } else {
      // If no specific country found, mark as Unknown
      country = 'Unknown';
    }
    
    return {
      id: f.id || `earthquake_${index}`, // Generate ID if not present
      lon, lat, depth,
      mag: +f.magnitude,
      place: f.place,
      timeISO: date.toISOString(),
      year: year,
      country: country
    };
  }).filter(d => d && d.year >= 1900 && d.year <= 2030); // Expanded range to handle actual data, filter out nulls
  
  console.log('Processed earthquakes:', quakes.length);
  console.log('Sample processed earthquake:', quakes[0]);
  console.log('Year range:', d3.extent(quakes, d => d.year));
  console.log('Magnitude range:', d3.extent(quakes, d => d.mag));
  console.log('Countries found:', [...new Set(quakes.map(d => d.country))].slice(0, 10));

  // Add manually corrected important earthquakes that might be missing
  const manualEarthquakes = [
    {
      id: 'valdivia_1960_manual',
      lat: -38.143,
      lon: -73.407,
      depth: 25,
      mag: 9.5,
      place: '1960 Great Chilean Earthquake (Valdivia Earthquake)',
      timeISO: new Date(1960, 0, 1).toISOString(),
      year: 1960,
      country: 'Chile'
    },
    {
      id: 'alaska_1964_manual',
      lat: 61.02,
      lon: -147.65,
      depth: 25,
      mag: 9.2,
      place: '1964 Alaska Earthquake',
      timeISO: new Date(1964, 2, 27).toISOString(),
      year: 1964,
      country: 'United States'
    },
    {
      id: 'tohoku_2011_manual',
      lat: 38.297,
      lon: 142.373,
      depth: 29,
      mag: 9.0,
      place: '2011 Tohoku Earthquake',
      timeISO: new Date(2011, 2, 11).toISOString(),
      year: 2011,
      country: 'Japan'
    },
    {
      id: 'kamchatka_1952_manual',
      lat: 52.623,
      lon: 159.779,
      depth: 30,
      mag: 9.0,
      place: '1952 Kamchatka Earthquake',
      timeISO: new Date(1952, 10, 4).toISOString(),
      year: 1952,
      country: 'Russia'
    },
    {
      id: 'maule_2010_manual',
      lat: -35.846,
      lon: -72.719,
      depth: 35,
      mag: 8.8,
      place: '2010 Maule, Chile Earthquake',
      timeISO: new Date(2010, 1, 27).toISOString(),
      year: 2010,
      country: 'Chile'
    },
    {
      id: 'rat_islands_1965_manual',
      lat: 51.25,
      lon: 178.72,
      depth: 30,
      mag: 8.7,
      place: '1965 Rat Islands, Alaska Earthquake',
      timeISO: new Date(1965, 1, 4).toISOString(),
      year: 1965,
      country: 'United States'
    },
    {
      id: 'assam_1950_manual',
      lat: 28.5,
      lon: 96.5,
      depth: 15,
      mag: 8.6,
      place: '1950 Assam-Tibet Earthquake',
      timeISO: new Date(1950, 7, 15).toISOString(),
      year: 1950,
      country: 'India'
    },
    {
      id: 'sumatra_2005_manual',
      lat: 2.085,
      lon: 97.108,
      depth: 30,
      mag: 8.6,
      place: '2005 Sumatra Earthquake',
      timeISO: new Date(2005, 2, 28).toISOString(),
      year: 2005,
      country: 'Indonesia'
    }
  ];
  
  // Add manual earthquakes to the main dataset
  quakes.push(...manualEarthquakes);
  console.log('=== EARTHQUAKE DATA SUMMARY ===');
  console.log('Added', manualEarthquakes.length, 'manually corrected earthquakes');
  console.log('Total earthquakes before deduplication:', quakes.length);
  
  // Remove duplicates based on place, year, and magnitude
  const seen = new Set();
  const uniqueQuakes = quakes.filter(quake => {
    const key = `${quake.place}-${quake.year}-${quake.mag}`;
    if (seen.has(key)) {
      console.log('Removing duplicate:', quake.place, quake.year, quake.mag);
      return false;
    }
    seen.add(key);
    return true;
  });
  
  quakes.length = 0; // Clear the array
  quakes.push(...uniqueQuakes); // Add unique earthquakes back
  
  console.log('Total earthquakes after deduplication:', quakes.length);
  console.log('Removed', manualEarthquakes.length + quakeData.length - quakes.length, 'duplicates');
  console.log('Sample earthquake:', quakes[0]);
  console.log('Valdivia in quakes:', quakes.find(d => d.place && d.place.includes('Valdivia')));
  console.log('================================');
  

  const byYear = d3.group(quakes, d => d.year);

  // Aggregate earthquake data by year for histogram
  const countsByYear = d3.rollup(quakes, v => v.length, d => d.year);

  // Function to draw year histogram
  function drawYearHistogram() {
    const actualYears = Array.from(byYear.keys()).sort((a, b) => a - b);
    const minYear = Math.min(...actualYears);
    const maxYear = Math.max(...actualYears);
    const yearRange = Array.from({length: maxYear - minYear + 1}, (_, i) => minYear + i);

    const maxCount = d3.max(Array.from(countsByYear.values()));

    const container = d3.select('#yearHistogram');
    // Clear any existing bars
    container.selectAll('div.bar').remove();
    
    const width = container.node().getBoundingClientRect().width;
    const height = container.node().getBoundingClientRect().height;

    const xScale = d3.scaleBand()
        .domain(yearRange)
        .range([0, width])
        .padding(0.1);

    const yScale = d3.scaleLinear()
        .domain([0, maxCount])
        .range([0, height]);

    container.selectAll('div.bar')
        .data(yearRange)
        .enter()
        .append('div')
        .style('position', 'absolute')
        .style('bottom', '0px')
        .style('left', d => `${xScale(d)}px`)
        .style('width', `${xScale.bandwidth()}px`)
        .style('height', d => `${yScale(countsByYear.get(d) || 0)}px`)
        .style('background-color', 'rgba(255, 255, 255, 0.3)');
  }

  // Call the function after countsByYear is created
  drawYearHistogram();

  // Populate country dropdown - only include earthquakes with proper country names
  const countrySet = new Set(quakes.map(d => d.country).filter(c => c && c !== 'Unknown' && c.trim() !== ''));
  
  // Sort countries alphabetically
  const sortedCountries = Array.from(countrySet).sort();
  
  // Function to populate a country select
  function populateCountrySelect(selectId) {
    const countrySelect = d3.select(selectId);
    
    // Add only countries with proper names
    sortedCountries.forEach(c => {
      countrySelect.append('option').attr('value', c).text(c);
    });
  }
  
  // Populate both country selects
  populateCountrySelect('#countrySelect');
  populateCountrySelect('#countrySelect2');

  // Scales
  const rScale = d3.scaleSqrt()
    .domain([6.5, 9.5])
    .range([1.2, 8.4]); // Much smaller circles: 1.2 to 8.4 pixels
  // Color scale by magnitude categories: Gold/Yellow → Red → Purple
  const quakeColorScale = d3.scaleLinear()
    .domain([7.0, 7.5, 8.0, 9.0, 10.0])
    .range(["#FFD700", "#FF8C00", "#FF4500", "#DC143C", "#8B008B"]) // Gold → Dark Orange → Red Orange → Crimson → Dark Magenta
    .clamp(true);
  function getMagColor(mag) {
    return quakeColorScale(mag);
  }

  // Temporal opacity scale: older earthquakes more translucent, newer more vivid
  const temporalOpacityScale = d3.scaleLinear()
    .domain([1925, 2025])
    .range([0.2, 1.0])  // More pronounced difference: very old (0.2) to recent (1.0)
    .clamp(true);
  function getTemporalOpacity(year) {
    const opacity = temporalOpacityScale(year);
    console.log(`Temporal opacity for year ${year}: ${opacity}`);
    return opacity;
  }

  // Create magnitude legend
  function createMagnitudeLegend() {
    const legendContainer = d3.select('#magnitudeLegend');
    legendContainer.html('');

    // Define magnitude ranges for legend
    const magnitudeRanges = [
      { min: 7.0, max: 7.5, label: "M 7.0 - 7.5", description: "Strong" },
      { min: 7.5, max: 8.0, label: "M 7.5 - 8.0", description: "Major" },
      { min: 8.0, max: 9.0, label: "M 8.0 - 9.0", description: "Great" },
      { min: 9.0, max: 10.0, label: "M 9.0+", description: "Extreme (rare)" }
    ];

    magnitudeRanges.forEach(range => {
      const avgMag = (range.min + range.max) / 2;
      const radius = rScale(avgMag);
      const color = getMagColor(avgMag);
      
      const legendItem = legendContainer.append('div')
        .attr('class', 'legend-item')
        .attr('data-min-mag', range.min)
        .attr('data-max-mag', range.max);

      // Add checkbox
      legendItem.append('input')
        .attr('type', 'checkbox')
        .attr('class', 'legend-checkbox')
        .attr('checked', true) // All ranges selected by default
        .on('change', function() {
          const isChecked = this.checked;
          const rangeKey = `${range.min}-${range.max}`;
          
          if (isChecked) {
            selectedMagnitudeRanges.add(rangeKey);
            legendItem.classed('selected', true).classed('unselected', false);
          } else {
            selectedMagnitudeRanges.delete(rangeKey);
            legendItem.classed('selected', false).classed('unselected', true);
          }
          
          // Redraw the map with new filtering
          drawYear(currentYear);
        });

      legendItem.append('div')
        .attr('class', 'legend-circle')
        .style('width', (radius * 2) + 'px')
        .style('height', (radius * 2) + 'px')
        .style('background-color', color)
        .style('border', `1px solid rgba(255,255,255,0.3)`);

      legendItem.append('div')
        .attr('class', 'legend-text')
        .html(`<span class="legend-magnitude">M ${range.label}</span><br>${range.description}`);

      // Initialize as selected
      legendItem.classed('selected', true);
      selectedMagnitudeRanges.add(`${range.min}-${range.max}`);
    });
  }

  // Active filters
  let activeCountry = '';
  let activeSpecificYear = null;
  let selectedCountryPath = null;
  let selectedMagnitudeRanges = new Set(); // Track selected magnitude ranges
  let minMagFilter = 7.0;
  let maxMagFilter = 9.5;

  // View mode state
  let viewMode = 'default'; // 'default' or 'animation'
  
  // Controls are now in the sidebar


  // Legacy functions for compatibility (now unused but kept for reference)
  function highlightEarthquakesByMagnitude(minMag, maxMag) {
    // This function is now replaced by updateEarthquakeVisibility
  }

  function clearEarthquakeHighlight() {
    // This function is now replaced by updateEarthquakeVisibility
  }

  // Zoom state management removed - using inline onclick handlers with built-in checks

  function highlightSelectedCountry(name) {
    // Country layer removed - this function does nothing
  }

  function populateSidebarForCountry(name) {
    const sidebarTitle = d3.select('#sidebarCountry');
    const listEl = d3.select('#sidebarList');
    sidebarTitle.text(name || 'None');
    listEl.html('');
    if (!name) return;
    const items = quakes.filter(q => q.country === name)
      .sort((a,b) => {
        // First sort by whether country is properly named (proper names first)
        const aHasProperCountry = a.country && a.country !== 'Unknown' && a.country.trim() !== '';
        const bHasProperCountry = b.country && b.country !== 'Unknown' && b.country.trim() !== '';
        
        if (aHasProperCountry && !bHasProperCountry) return -1;
        if (!aHasProperCountry && bHasProperCountry) return 1;
        
        // If both have same country status, sort by year (descending)
        return d3.descending(a.year, b.year);
      });
    if (items.length === 0) {
      listEl.append('div').attr('class','item').text('No data available.');
      return;
    }
    items.forEach(it => {
      listEl.append('div').attr('class','item')
        .html(`<strong>${it.year}</strong> · M ${it.mag} — ${it.place}`);
    });
    
    // Add Clear Selection button after the list
    listEl.append('div').attr('class','item').style('margin-top', '12px').style('padding-top', '12px').style('border-top', '1px solid rgba(255,255,255,0.1)')
      .append('button')
      .attr('class', 'clear-btn')
      .style('width', '100%')
      .text('Clear Selection')
      .on('click', () => {
        // Clear the country selection and return to main screen
        activeCountry = '';
        d3.select('#activeCountryText').text('None');
        d3.select('#countrySelect').property('value', '');
        d3.select('#countrySelect2').property('value', '');
        highlightSelectedCountry('');
        
        // Return to main screen by restoring the original sidebar content
        const sidebarContent = d3.select("#sidebarList");
        sidebarContent.html(`
          <div class="welcome-header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 4px;">
              <h3>This is the Earthquake Map</h3>
              <button id="helpBtn" class="help-button" title="Show help information" onclick="document.getElementById('helpModal').style.display='block'">?</button>
            </div>
            <p>Click on the button for detailed information</p>
          </div>
          
          <div class="view-controls">
            <h3>View Mode</h3>
            <div class="view-buttons">
              <button id="defaultViewBtn" class="view-btn active">Cumulative View</button>
              <button id="animationViewBtn" class="view-btn">Single Year View</button>
            </div>
          </div>
          
          <!-- Histogram section - only visible in single year view -->
          <div class="sidebar-section" id="histogramSection" style="display: none;">
            <h3>Earthquake Distribution by Year</h3>
            <div id="yearHistogram" class="histogram-container"></div>
          </div>
          
          <div class="sidebar-section" id="yearControlsSection" style="display: none;">
            <h3>Year Controls</h3>
            
            <div class="filter-group">
              <div class="label flex-between">
                <span>Year: <strong id="yearLabel">Loading...</strong></span>
                <input id="specificYearInput" type="number" class="year-input">
              </div>
              <div id="sliderWrap">
                <div id="yearTickLabels" class="tick-labels"></div>
                <div id="yearGuide" class="hidden"></div>
                <input id="yearSlider" type="range" step="1" list="yearDatalist">
                <datalist id="yearDatalist"></datalist>
              </div>
            </div>
            
            <div class="filter-group">
              <label for="speedControl">Animation Speed:</label>
              <select id="speedControl">
                <option value="1000">Slow (0.5x)</option>
                <option value="500" selected>Normal (1x)</option>
                <option value="250">Fast (2x)</option>
              </select>
            </div>
            
            <div class="filter-group">
              <button id="playBtn" aria-pressed="false">Play ▶</button>
            </div>
          </div>
          
          <div class="sidebar-section">
            <h3>Filters</h3>
            <div class="filter-group">
              <label>Country Filter:</label>
              <select id="countrySelect"><option value="">All Countries</option></select>
            </div>
            
            <div class="filter-group">
              <label>Magnitude Range:</label>
              <div class="magnitude-range">
                <div class="range-labels">
                  <span id="minMagLabel">7.0</span>
                  <span id="maxMagLabel">9.5</span>
                </div>
                <div class="range-inputs">
                  <input type="range" id="minMagSlider" min="7.0" max="9.5" step="0.1" value="7.0">
                  <input type="range" id="maxMagSlider" min="7.0" max="9.5" step="0.1" value="9.5">
                </div>
              </div>
            </div>
            
            <div class="filter-group">
              <button id="clearFiltersBtn">Clear All Filters</button>
            </div>
            
            <div class="active-filters">
              <div>Active Country: <strong id="activeCountryText">None</strong></div>
              <div>Active Year: <strong id="activeYearText">None</strong></div>
              <div>Magnitude Range: <strong id="activeMagText">7.0 - 9.5</strong></div>
            </div>
          </div>
        `);
        
        // Re-attach event handlers after restoring content
        attachSidebarEventHandlers();
        
        drawYear(currentYear);
      });
  }

  function updateSummaryStats(list) {
    // Calculate total earthquakes
    const totalCount = list.length;
    
    // Calculate largest magnitude
    const largestMag = list.length > 0 ? Math.max(...list.map(d => d.mag)) : 0;
    
    // Calculate most active country
    const countryCounts = {};
    list.forEach(d => {
      if (d.country && d.country !== 'Ocean') {
        countryCounts[d.country] = (countryCounts[d.country] || 0) + 1;
      }
    });
    const mostActiveCountry = Object.keys(countryCounts).length > 0 
      ? Object.keys(countryCounts).reduce((a, b) => countryCounts[a] > countryCounts[b] ? a : b)
      : 'N/A';
    
    // Update the UI
    d3.select('#totalEarthquakes').text(totalCount);
    d3.select('#largestMagnitude').text(largestMag > 0 ? largestMag.toFixed(1) : '-');
    d3.select('#mostActiveCountry').text(mostActiveCountry);
  }

  

  // Function to attach all sidebar event handlers
  function attachSidebarEventHandlers() {
    // Re-initialize year controls
    slider = d3.select("#yearSlider");
    yearLabel = d3.select("#yearLabel");
    
    // View mode button handlers
    d3.select('#defaultViewBtn').on('click', function() {
      viewMode = 'default';
      d3.select('#defaultViewBtn').classed('active', true);
      d3.select('#animationViewBtn').classed('active', false);
      d3.select('#playBtn').property('disabled', true);
      // Hide year controls and histogram in cumulative view
      d3.select('#yearControlsSection').style('display', 'none');
      d3.select('#histogramSection').style('display', 'none');
  drawYear(currentYear);
    });

    d3.select('#animationViewBtn').on('click', function() {
      viewMode = 'animation';
      d3.select('#animationViewBtn').classed('active', true);
      d3.select('#defaultViewBtn').classed('active', false);
      d3.select('#playBtn').property('disabled', false);
      // Show year controls and histogram in single year view
      d3.select('#yearControlsSection').style('display', 'block');
      d3.select('#histogramSection').style('display', 'block');
      // Redraw histogram when section becomes visible
      setTimeout(() => drawYearHistogram(), 100);
      drawYear(currentYear);
    });

    // Year slider handler
    if (slider.node()) {
  slider.on("input", function() {
    currentYear = +this.value;
    yearLabel.text(currentYear);
        d3.select('#specificYearInput').property('value', currentYear);
    drawYear(currentYear);
      });
    } else {
      console.error('Slider element not found!');
    }

    // Year input handler
    d3.select('#specificYearInput').on('input', function() {
      const val = +this.value;
      if (val >= minYear && val <= maxYear) {
        activeSpecificYear = val;
        currentYear = val;
        yearLabel.text(currentYear);
        if (slider.node()) {
          slider.property('value', val);
        }
        d3.select('#activeYearText').text(activeSpecificYear ?? 'None');
        drawYear(currentYear);
      }
    });

    // Play button
    d3.select('#playBtn').on('click', () => {
      if (!playing) {
        playing = true;
        d3.select('#playBtn').text("Pause ⏸");
        const speed = +d3.select("#speedControl").node().value;
        timer = setInterval(() => {
          currentYear++;
          if (slider.node() && currentYear > +slider.attr("max")) currentYear = +slider.attr("min");
          if (slider.node()) {
            slider.property("value", currentYear);
          }
          yearLabel.text(currentYear);
          drawYear(currentYear);
        }, speed);
      } else {
        playing = false;
        d3.select('#playBtn').text("Play ▶");
        clearInterval(timer);
      }
    });

    // Country filter
    d3.select('#countrySelect').on('change', () => {
    activeCountry = d3.select('#countrySelect').property('value') || '';
    d3.select('#activeCountryText').text(activeCountry || 'None');
    highlightSelectedCountry(activeCountry);
    populateSidebarForCountry(activeCountry);
    drawYear(currentYear);
  });

    // Country filter for the second select (in clearEarthquakeSelection)
    d3.select('#countrySelect2').on('change', () => {
    activeCountry = d3.select('#countrySelect2').property('value') || '';
    d3.select('#activeCountryText').text(activeCountry || 'None');
    highlightSelectedCountry(activeCountry);
    populateSidebarForCountry(activeCountry);
    drawYear(currentYear);
  });

    // Magnitude range filters
    d3.select('#minMagSlider').on('input', function() {
      minMagFilter = +this.value;
      d3.select('#minMagLabel').text(minMagFilter.toFixed(1));
      d3.select('#activeMagText').text(`${minMagFilter.toFixed(1)} - ${maxMagFilter.toFixed(1)}`);
    drawYear(currentYear);
    });

    d3.select('#maxMagSlider').on('input', function() {
      maxMagFilter = +this.value;
      d3.select('#maxMagLabel').text(maxMagFilter.toFixed(1));
      d3.select('#activeMagText').text(`${minMagFilter.toFixed(1)} - ${maxMagFilter.toFixed(1)}`);
      drawYear(currentYear);
    });

    // Clear filters
  d3.select('#clearFiltersBtn').on('click', () => {
    activeCountry = '';
    activeSpecificYear = null;
      minMagFilter = 7.0;
      maxMagFilter = 9.5;
    d3.select('#activeCountryText').text('None');
    d3.select('#activeYearText').text('None');
      d3.select('#activeMagText').text('7.0 - 9.5');
      d3.select('#countrySelect').property('value', '');
      d3.select('#countrySelect2').property('value', '');
      d3.select('#specificYearInput').property('value', currentYear);
      d3.select('#minMagSlider').property('value', 7.0);
      d3.select('#maxMagSlider').property('value', 9.5);
      d3.select('#minMagLabel').text('7.0');
      d3.select('#maxMagLabel').text('9.5');
    populateSidebarForCountry('');
    // Country layer removed - no need to reset country styling
    drawYear(currentYear);
  });
  }

  function drawYear(year) {
    
    let list;
    
    if (viewMode === 'default') {
      // Default view: show ALL earthquakes with temporal opacity
      const useAllYearsForCountry = !!activeCountry && activeSpecificYear == null;
      const useAllYearsDefault = !activeCountry && activeSpecificYear == null;
      const base = (useAllYearsForCountry || useAllYearsDefault) ? quakes : (byYear.get(+year) || []);
      list = base;
    } else {
      // Animation view: show only earthquakes for the specific year
      list = byYear.get(+year) || [];
    }
    
    if (activeCountry) {
      list = list.filter(d => d.country === activeCountry);
    }
    if (activeSpecificYear != null) {
      list = list.filter(d => d.year === activeSpecificYear);
    }
    
    
    // Apply magnitude range filter
    list = list.filter(d => d.mag >= minMagFilter && d.mag <= maxMagFilter);
    
    // Apply magnitude legend filtering
    const beforeMagnitudeFilter = list.length;
    list = list.filter(d => {
      for (const rangeKey of selectedMagnitudeRanges) {
        const [min, max] = rangeKey.split('-').map(Number);
        if (d.mag >= min && d.mag <= max) { // Changed < to <= to include the upper bound
          return true;
        }
      }
      return false;
    });

    // Update summary statistics
    updateSummaryStats(list);

    // Clear existing earthquake markers
    earthquakeLayer.clearLayers();
    

    // Add new earthquake markers to Leaflet map
    
    // Check opacity distribution
    const opacityStats = {};
    list.forEach((d, index) => {
      const opacity = viewMode === 'default' ? getTemporalOpacity(d.year) : 1.0;
      
      // Track opacity distribution
      const opacityKey = Math.round(opacity * 10) / 10; // Round to 1 decimal
      opacityStats[opacityKey] = (opacityStats[opacityKey] || 0) + 1;
      
    });
    
    // Now draw the earthquakes
    list.forEach((d, index) => {
      const opacity = viewMode === 'default' ? getTemporalOpacity(d.year) : 1.0;
      
      // Special handling for Valdivia earthquake to make it very visible
      let finalRadius = rScale(d.mag);
      let finalColor = getMagColor(d.mag);
      let finalOpacity = opacity;
      
      if (d.place && d.place.includes('Valdivia')) {
        finalRadius = Math.max(rScale(d.mag), 15); // Ensure minimum size
        // Use normal magnitude color (purple for M9.5 = Extreme category)
        // Don't override opacity - use the calculated temporal opacity
      }
      
      const circle = L.circleMarker([d.lat, d.lon], {
        radius: finalRadius,
        color: finalColor,
        fillColor: finalColor,
        fillOpacity: finalOpacity,
        weight: 2
      }).addTo(earthquakeLayer);

      // Add popup
      circle.bindPopup(`
        <strong>${d.place}</strong><br>
        Magnitude: ${d.mag}<br>
        Year: ${d.year}<br>
        Country: ${d.country}
      `);

      // Add click handler for map interaction
      circle.on('click', (e) => {
        // No additional action needed
      });

      // Add hover effects with smooth animation
      circle.on('mouseover', (e) => {
        // Store original radius for restoration
        if (!circle._originalRadius) {
          circle._originalRadius = finalRadius;
        }
        // Make circle bigger on hover (1.4x original size - 40% larger)
        const hoverRadius = circle._originalRadius * 1.4;
        circle.setRadius(hoverRadius);
      });
      
      circle.on('mouseout', (e) => {
        // Return to original size
        if (circle._originalRadius) {
          circle.setRadius(circle._originalRadius);
        }
      });

    });
  }

  // Initialize year controls
  
  // Initialize zoom button states - removed since we're using inline onclick handlers
  
  // Create the magnitude legend
  createMagnitudeLegend();
  
  // Initialize year controls variables
  let actualYears = Array.from(byYear.keys()).sort((a, b) => a - b);
  let minYear = Math.min(...actualYears);
  let maxYear = Math.max(...actualYears);
  let currentYear = minYear;
  let slider, yearLabel;
  
  // Initialize year controls after DOM is ready
  function initializeYearControls() {
    slider = d3.select("#yearSlider");
    yearLabel = d3.select("#yearLabel");
    
    if (slider.node()) {
      // Update slider attributes to match actual data range
      slider.attr("min", minYear).attr("max", maxYear).attr("value", currentYear);
      d3.select("#specificYearInput").attr("min", minYear).attr("max", maxYear).attr("value", currentYear);
      yearLabel.text(currentYear);
      
      drawYear(currentYear);
    } else {
      console.error('Slider element not found!');
    }
  }
  
  // Call initialization
  initializeYearControls();

  // Initialize all event handlers
  attachSidebarEventHandlers();

  // Controls now use inline onclick handlers - no complex setup needed

  // Also disable it on initial load
  d3.select('#playBtn').property('disabled', true);
  
  // Add direct event listener for slider as backup
  setTimeout(() => {
    const sliderElement = document.getElementById('yearSlider');
    if (sliderElement) {
      sliderElement.addEventListener('input', function() {
        currentYear = +this.value;
        yearLabel.text(currentYear);
        d3.select('#specificYearInput').property('value', currentYear);
        drawYear(currentYear);
      });
    } else {
      console.error('Slider element not found for direct listener');
    }
  }, 2000);

  // Build tick labels under the slider
  const tickContainer = d3.select("#yearTickLabels");
  const datalist = d3.select("#yearDatalist");
  // Add datalist options for better slider behavior
  for (let y = minYear; y <= maxYear; y++) {
    datalist.append("option").attr("value", y);
  }

  let playing = false;
  let timer = null;
  const playBtn = d3.select("#playBtn");
  playBtn.on("click", () => {
    if (!playing) {
      playing = true;
      playBtn.text("Pause ⏸");
      const speed = +d3.select("#speedControl").node().value;
      timer = setInterval(() => {
        currentYear++;
        if (currentYear > +slider.attr("max")) currentYear = +slider.attr("min");
        slider.property("value", currentYear);
        yearLabel.text(currentYear);
        drawYear(currentYear);
      }, speed);
    } else {
      playing = false;
      playBtn.text("Play ▶");
      clearInterval(timer);
    }
  });

  // Help modal event listeners
  d3.select('#helpBtn').on('click', () => {
    d3.select('#helpModal').style('display', 'block');
  });
  d3.select('#closeHelpBtn').on('click', () => {
    d3.select('#helpModal').style('display', 'none');
  });
  
  // Fallback event listeners using regular JavaScript
  setTimeout(() => {
    const helpBtn = document.getElementById('helpBtn');
    const closeBtn = document.getElementById('closeHelpBtn');
    const modal = document.getElementById('helpModal');
    
    if (helpBtn) {
      helpBtn.addEventListener('click', () => {
        if (modal) {
          modal.style.display = 'block';
        }
      });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        if (modal) {
          modal.style.display = 'none';
        }
      });
    }
    
    // Close modal when clicking outside
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
    
    // Modal is ready - no automatic opening
  }, 1000);

})();

// Global functions for inline onclick handlers
function toggleSummary() {
  const summarySection = document.getElementById('summarySection');
  const summaryToggle = document.getElementById('summaryToggle');
  
  if (summarySection && summaryToggle) {
    if (summarySection.style.display === 'none') {
      summarySection.style.display = 'block';
      summaryToggle.classList.add('expanded');
    } else {
      summarySection.style.display = 'none';
      summaryToggle.classList.remove('expanded');
    }
  }
}

function toggleTransparency() {
  const transparencySection = document.getElementById('transparencySection');
  const transparencyToggle = document.getElementById('transparencyToggle');
  
  if (transparencySection && transparencyToggle) {
    if (transparencySection.style.display === 'none') {
      transparencySection.style.display = 'block';
      transparencyToggle.classList.add('expanded');
    } else {
      transparencySection.style.display = 'none';
      transparencyToggle.classList.remove('expanded');
    }
  }
}

function toggleLegend() {
  const legendSection = document.getElementById('legendSection');
  const legendToggle = document.getElementById('legendToggle');
  
  if (legendSection && legendToggle) {
    if (legendSection.style.display === 'none') {
      legendSection.style.display = 'block';
      legendToggle.classList.add('expanded');
    } else {
      legendSection.style.display = 'none';
      legendToggle.classList.remove('expanded');
    }
  }
}

// Make map globally accessible
window.map = map;

</script>

<div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
  <div style="position: relative; max-width: 900px; margin: 20px auto; background: linear-gradient(180deg, rgba(6,34,74,0.95) 0%, rgba(42,11,74,0.95) 100%); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 30px; color: #e7f0ff;">
    <button id="closeHelpBtn" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #e7f0ff; padding: 8px 12px; cursor: pointer; font-size: 14px;" onclick="document.getElementById('helpModal').style.display='none'">✕</button>
    
    <div class="visualization-legend">
      <h2 style="margin: 0 0 30px 0; color: #fff; font-size: 24px; text-align: center;">How to Read This Map</h2>
      
      <div class="legend-section">
        <h4>Earthquake Circles</h4>
        <div class="legend-item">
          <div class="legend-circle" style="width: 12px; height: 12px; background-color: #ffd54a; margin-right: 12px;"></div>
          <div class="legend-text">
            <strong>Size:</strong> Larger circles = higher magnitude<br>
            <strong>Color:</strong> Yellow (7.0-7.4) → Orange (7.5-7.9) → Red (8.0+)
          </div>
        </div>
      </div>
      
      <div class="legend-section">
        <h4>Temporal Opacity (Cumulative View)</h4>
        <div class="legend-item">
          <div class="legend-circle" style="width: 12px; height: 12px; background-color: #ff3b30; opacity: 0.2; margin-right: 12px;"></div>
          <div class="legend-text">
            <strong>Older earthquakes (1925-1950):</strong> Very transparent
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-circle" style="width: 12px; height: 12px; background-color: #ff3b30; opacity: 0.6; margin-right: 12px;"></div>
          <div class="legend-text">
            <strong>Middle years (1950-2000):</strong> Semi-transparent
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-circle" style="width: 12px; height: 12px; background-color: #ff3b30; opacity: 1.0; margin-right: 12px;"></div>
          <div class="legend-text">
            <strong>Recent earthquakes (2000-2025):</strong> Fully opaque
          </div>
        </div>
      </div>
      
      <div class="legend-section">
        <h4>View Modes</h4>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Cumulative View:</strong> Shows all earthquakes with temporal opacity based on their age
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Single Year View:</strong> Shows only earthquakes from the selected year
          </div>
        </div>
      </div>
      
      <div class="legend-section">
        <h4>Interactive Controls</h4>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Year Slider:</strong> Navigate through time to see earthquakes by year<br>
            <strong>Play Button:</strong> Animate through years automatically<br>
            <strong>Magnitude Legend:</strong> Filter earthquakes by magnitude ranges<br>
            <strong>Country Filter:</strong> Focus on specific regions or countries<br>
            <strong>Magnitude Range Sliders:</strong> Set custom magnitude ranges
          </div>
        </div>
      </div>
      
      <div class="legend-section">
        <h4>Map Features</h4>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Click Earthquake Circles:</strong> View detailed information in the sidebar<br>
            <strong>Summary Panel:</strong> Real-time statistics about visible earthquakes
        </div>
      </div>
    </div>
    
      <div class="legend-section">
        <h4>Data Information</h4>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Source:</strong> U.S. Geological Survey (USGS)<br>
            <strong>Magnitude Range:</strong> 7.0 and above (major earthquakes)<br>
            <strong>Time Period:</strong> 1925-2025<br>
            <strong>Total Earthquakes:</strong> Over 1,200 major earthquakes worldwide
          </div>
        </div>
      </div>
      
      <div class="legend-section">
        <h4>Understanding Earthquake Patterns</h4>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Ring of Fire:</strong> Notice the concentration of earthquakes around the Pacific Ocean<br>
            <strong>Tectonic Boundaries:</strong> Most earthquakes occur along plate boundaries<br>
            <strong>Temporal Patterns:</strong> Use the year slider to see how earthquake activity changes over time<br>
            <strong>Magnitude Distribution:</strong> Larger earthquakes are rarer but more destructive
          </div>
        </div>
      </div>
      
      <div class="legend-section">
        <h4>Tips for Exploration</h4>
        <div class="legend-item">
          <div class="legend-text">
            <strong>Start with Cumulative View:</strong> See the big picture of earthquake distribution<br>
            <strong>Use Single Year View:</strong> Focus on specific time periods<br>
            <strong>Filter by Country:</strong> Explore regional earthquake patterns<br>
            <strong>Try the Animation:</strong> Watch how earthquake activity changes over decades<br>
            <strong>Check the Summary:</strong> Get quick statistics about your current view
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
